<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <style type="text/css">
        body{background-color: bisque;position: absolute;left: 0;top: 0;right: 0;bottom: 0;}
        canvas{
            position: fixed;
            top:0;
            left:0;
        }
    </style>
</head>
<body>

<canvas id="fk" width="200" height="200" style="background-color: aqua">您的浏览器不支持Canvas。</canvas>
<canvas id="myCanvas" width="200" height="200">您的浏览器不支持Canvas。</canvas>

<script >

        var canvas,ctx,shape,bg,canvas2,ctx2;
        canvas = document.getElementById('myCanvas');
        canvas2 = document.getElementById('fk');
        ctx = canvas.getContext('2d');
        ctx2 = canvas2.getContext('2d');
        bg = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
        shape = {
            s1: [
                {
                    mo: [
                        [0, 0, 0, 0],
                        [0, 0, 0, 0],
                        [0, 0, 0, 0],
                        [1, 1, 1, 1]
                    ]

                },
                {
                    mo: [
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0]
                    ]

                }
            ],
            s2: [
                {
                    mo: [
                        [1, 1, 0, 0],
                        [1, 1, 0, 0],
                        [0, 0, 0, 0],
                        [0, 0, 0, 0]
                    ]
                }
            ],
            s3: [
                {
                    mo: [
                        [1, 0, 0, 0],
                        [1, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [0, 0, 0, 0],
                        [0, 1, 1, 0],
                        [1, 1, 0, 0],
                        [0, 0, 0, 0]
                    ]
                }
            ],
            s4: [
                {
                    mo: [
                        [0, 1, 0, 0],
                        [1, 1, 0, 0],
                        [1, 0, 0, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [0, 0, 0, 0],
                        [1, 1, 0, 0],
                        [0, 1, 1, 0],
                        [0, 0, 0, 0]
                    ]
                }
            ],
            s5: [
                {
                    mo: [
                        [1, 0, 0, 0],
                        [1, 0, 0, 0],
                        [1, 1, 0, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [0, 0, 0, 0],
                        [1, 1, 1, 0],
                        [1, 0, 0, 0],
                        [0, 0, 0, 0]
                    ],
                    l:true,
                    r:true
                },
                {
                    mo: [
                        [1, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [0, 0, 0, 0],
                        [0, 0, 1, 0],
                        [1, 1, 1, 0],
                        [0, 0, 0, 0]
                    ]
                }
            ],
            s6: [
                {
                    mo: [
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [1, 1, 0, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [0, 0, 0, 0],
                        [1, 0, 0, 0],
                        [1, 1, 1, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [1, 1, 0, 0],
                        [1, 0, 0, 0],
                        [1, 0, 0, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [0, 0, 0, 0],
                        [1, 1, 1, 0],
                        [0, 0, 1, 0],
                        [0, 0, 0, 0]
                    ]
                }
            ],
            s7: [
                {
                    mo: [
                        [0, 0, 0, 0],
                        [0, 1, 0, 0],
                        [1, 1, 1, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [1, 0, 0, 0],
                        [1, 1, 0, 0],
                        [1, 0, 0, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [0, 0, 0, 0],
                        [1, 1, 1, 0],
                        [0, 1, 0, 0],
                        [0, 0, 0, 0]
                    ]
                },
                {
                    mo: [
                        [0, 1, 0, 0],
                        [1, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 0, 0, 0]
                    ]
                }
            ]
        };

        var _x = 50;//初始的偏移值50
        var _y = 10;//初始的偏移值10
        var _d;
        var len =0;
        var index =0;
        var start =true;
        //开始
        var t=setInterval(function () {
            if(start){
                start=false;
                _x = 50;//初始的偏移值50
                _y = 10;//初始的偏移值10
                index=0;

                _d = shape['s'+parseInt(Math.random()*7+1)];
                len =_d.length;
                drop(_d);
            }

        },500);
        //开始
        //创建 往下掉
        function drop() {
            ctx.clearRect(0,0,200,200);

            _y+=10;
        var state=true;
            for(var i = 0; i < 4; i++) {
                for(var j = 0; j < 4; j++) {
                    if(_d[index].mo[i][j]==1){
                        if((j+_y/10+1)<20&&(bg[j+_y/10+1][i+_x/10] !=1)){
                            ctx.fillStyle = 'red';
                            ctx.fillRect(i*10+_x,j*10+_y,10,10);
                        }else{
                            state =false;

                        }
//
                    }
                }
            }
            if(!state){
                ctx.clearRect(0,0,200,200);
                //改变bg数组
                for(var i = 0; i < 4; i++) {
                    for(var j = 0; j < 4; j++) {
                        if(_d[index].mo[i][j]==1) {
                            bg[j+ _y / 10][i + _x / 10] = 1
                        }
                    }
                }
                fkbg()
            }else{
                 setTimeout(arguments.callee,200)
            }
        }
        window.onkeydown=function(e){
            switch (e.keyCode){
                case 38://上
                    if(index==0){
                        index=len-1
                    }else{
                        index--
                    }
                    break;
                case 40://下
                        if(index+1<len){
                            index++;
                        }else{
                            index=0
                        }
                    break;
                case 37://左
                    if(_x>=10){
                        _x-=10;
                    }
                    break;
                case 39://右
                    if(_x<=160){
                        _x+=10;
                    }
                    break;
                default:
                    break;
            }
        };
        function fkbg() {
            start=true;
            //清空画布
            ctx2.clearRect(0,0,200,200);
            for(var i = 0; i < 20; i++) {
                for(var j = 0; j < 20; j++) {
                    if(bg[j][i]==1){
                           ctx2.fillStyle = 'red';
                           ctx2.fillRect(i*10,j*10,10,10);
                    }

                }

            }
            var vanish = true;
            var _index = 0;
            for(var _i = 0; _i < 20; _i++) {
                vanish = true;
                for(var _j = 0; _j < 20; _j++) {
                    if (bg[_i][_j] == 0) {
                        vanish = false
                    }
                }
                if(vanish){
                    bg.remove(_i);
                    bg.unshift([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);
                    fkbg()
                }
            }
            for(var k=0;k<20;k++){
                if(bg[2][k]==1){
                    alert('完啦');
                    clearInterval(t)
                }
            }

        }

        Array.prototype.remove=function(dx)
        {
            if(isNaN(dx)||dx>this.length){return false;}
            for(var i=0,n=0;i<this.length;i++)
            {
                if(this[i]!=this[dx])
                {
                    this[n++]=this[i]
                }
            }
            this.length-=1
        }
</script>
</body>
</html>